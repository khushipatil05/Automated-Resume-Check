<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recruiter Dashboard</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        .container { max-width: 800px; margin: auto; padding: 2em; border: 1px solid #ccc; border-radius: 5px; }
        .form-group { margin-bottom: 1em; }
        label { display: block; margin-bottom: .5em; }
        input, select, textarea { width: 100%; padding: .5em; }
        .btn { padding: .75em 1.5em; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .job-list { margin-top: 2em; }
        .job-item { padding: 1em; border: 1px solid #eee; margin-bottom: 1em; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Recruiter Dashboard</h2>
        <p>Welcome, {{ current_user.name }}!</p>

        <!-- Form to Add a New Job -->
        <div id="add-job-form">
            <h3>Post a New Job</h3>
            <form id="jd-upload-form" action="/jd/upload" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="jd-file">Upload Job Description (.pdf, .docx)</label>
                    <input type="file" id="jd-file" name="file" accept=".pdf,.docx" required>
                </div>
                <button type="submit" class="btn">Parse Job Description</button>
            </form>
            <div id="parsed-results" style="display:none; margin-top: 1em;">
                <h4>Extracted Details</h4>
                <form id="job-post-form">
                    <div class="form-group">
                        <label>Role Title</label>
                        <input type="text" id="role_title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label>Must-Have Skills (comma-separated)</label>
                        <textarea id="must_have_skills" name="keywords" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Qualifications</label>
                        <textarea id="qualifications" name="description" rows="4" required></textarea>
                    </div>
                     <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="location" name="location">
                    </div>
                    <button type="submit" class="btn">Post This Job</button>
                </form>
            </div>
        </div>

        <!-- List of Posted Jobs -->
        <div class="job-list">
            <h3>Your Posted Jobs</h3>
            {% for job in jobs %}
                <div class="job-item">
                    <h4><a href="/job-analytics/{{ job.id }}">{{ job.title }}</a></h4>
                    <p>{{ job.required_skills | join(', ') }}</p>
                </div>
            {% else %}
                <p>You have not posted any jobs yet.</p>
            {% endfor %}
        </div>
    </div>

    <script>
        // Handle the Job Description Upload
        document.getElementById('jd-upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const resultsDiv = document.getElementById('parsed-results');

            try {
                const response = await fetch(form.action, { method: 'POST', body: formData });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('role_title').value = data.role_title || '';
                    document.getElementById('must_have_skills').value = (data.must_have_skills || []).join(', ');
                    document.getElementById('qualifications').value = data.qualifications || '';
                    resultsDiv.style.display = 'block';
                } else {
                    alert('Error parsing job description: ' + data.error);
                }
            } catch (error) {
                alert('An unexpected error occurred during parsing.');
            }
        });

        // Handle the Final Job Posting
        document.getElementById('job-post-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const jobData = {
                title: form.title.value,
                keywords: form.keywords.value.split(',').map(s => s.trim()),
                description: form.description.value,
                location: form.location.value
            };

            try {
                const response = await fetch('/jobs', { 
                    method: 'POST', 
                    body: JSON.stringify(jobData),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                if (response.ok) {
                    alert('Job posted successfully!');
                    window.location.reload(); // Refresh to see the new job
                } else {
                    alert('Error posting job: ' + result.error);
                }
            } catch (error) {
                alert('An unexpected error occurred during posting.');
            }
        });
    </script>
</body>
</html>
